:numbered:

By now you should have the *chi mapping tool* compiled and ready to run. 

The next step is to create a parameter file to tell the code how to analyse your data. 

== The parameters

Here is a quick overview of how to set up and run the code, if you have run a *LSDTopoTools* analysis before:

. The beginning of your parameter file has information about the location and names of the input and ouput:

[source,paramfile]
----
read path: /home/boris/path/to/file/
read fname: name_of_dem_without_extension

write path: /home/boris/path/to/file/
write fname: prefix_for_output
----

. These parameters are linked to drainage network extraction, an exhaustive list is provided later. Here is a basic drainage extraction:
[source,paramfile]
----
threshold_contributing_pixels: 2000
minimum_basin_size_pixels: 200000
maximum_basin_size_pixels: 5000000
m_over_n: 0.45
----

. A list of options for the chi ananlysis can be found in our sections on link:LSDTT_chi_analysis.html#_parameter_file_options[channel steepness analysis]

. The options specific to the knickpoint analysis can be found in the link:LSDTT_chi_analysis.html#_parameters_for_knickpoint_analyses[this section of the parameters for the chi tool].

. The following parameters define the stem:[k_{sn}] extraction, using https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/2013JF002981[Mudd et al., 2014 JGR] algorithm:
.. `force_skip_knickpoint_analysis: 2`: Number of nodes skipped during each Monte Carlo iterations. 1 - 4. A lower value means a better fit to chi-plot profile, but also more sensitive to noise.
.. `force_n_iteration_knickpoint_analysis: 40`: number of iteration for the segment testing. 20 is the minimum, over that value it does not change a lot the calculation.
.. `target_nodes: 80`: Will set the number of nodes investigated per segment. combined with `force_skip_knickpoint_analysis`, it will determine the size of the segments and thus the precision of the fitting (do you want the main trend or detail analysis?). *Over 100 nodes, it becomes computationally really expensive, over 120, you will need days of processing, over 150, probably months, over 200 you won't be alive when the results will strike. It depends on your priorities.* 50-100 nodes will fit most of the needs.
.. Other parameters can be adjusted for the segment fitting algorithm, you can refer to the link:LSDTT_chi_analysis.html#_parameters_for_segmentation_of_channels[documentation] or https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/2013JF002981[Mudd et al., 2014 JGR].

. The following parameters control the knickpoint extraction:
.. `ksn_knickpoint_analysis: true`: switch on the analysis, as other analysis are available through `chi_mapping_tools.exe`, namely Chi extraction, stem:[M_{\chi}] extraction from https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/2013JF002981[Mudd et al., 2014 JGR] and concavity index extraction from Mudd et al., 2018 Esurf.
.. `TVD_lambda: -1`: define the regulation parameter for the Total Variation Denoising algorithm, adapted from https://ieeexplore.ieee.org/abstract/document/6579659/[Condat, 2013]. `-1` will choose an automatic value depending on your concavity. This parameter depends on the magnitude of stem:[k_{sn}] and can be adjusted manually. Higher stem:[\lambda] values will produce a clearer signal but may inhibit or lower some knickpoint (stem:[\Delta k_{sn}]). -1 is the default. 
.. `kp_node_combining: 10`: Determine the combining window for stem:[\Delta k_{sn}] knickpoint. It avoids getting artifact knickpoints, but a high window can shift knickpoint location. A low window can scatter large knickpoints into successive small ones. 10 is the deafult. 
.. `window_stepped_kp_detection: 100`: Determine the window for windowed statistics on segmented elevation to detect stepped knickpoints. Low windows are unefficient to catch these steps. 100 is the default
.. `std_dev_coeff_stepped_kp: 8`: Std deviation threshold to catch these variations. 7 - 9 gives a pretty reliable results. Lower value would produce many artifacts. 4 is the default

. A typical parameter file would look like:

[source,paramfile]
----
# Parameters for selecting channels and basins
threshold_contributing_pixels: 2500
minimum_basin_size_pixels: 200000
maximim_basin_size_pixels: 500000
test_drainage_boundaries: false

# Parameters for chi analysis
A_0: 1
m_over_n: 0.5
n_iterations: 20
target_nodes: 80
minimum_segment_length: 10
sigma: 10.0
skip: 2

# ksn_knickpoint_analysis
ksn_knickpoint_analysis: true
TVD_lambda: -1
std_dev_coeff_stepped_kp: 8
----

== Running the codeand outputs

. Once you have link:LSDTT_chi_analysis.html#_installing_the_code_and_setting_up_directories[set up the chi mapping tool] you simply run the code pointing to your parameter file:
+
[source,console]
----
$ chi_mapping_tool.exe /path/to/parameter/file parameter_file.driver
----
+
. Your life will be easier if you ensure the paths and filenames are all correct. 
+
. The analysis will then churn away for some time, printing all manner of things to screen which hopefully are not error reports and that you can safely ignore. 
+
. At the end of the process, you will have several new files:
+
.. `_ksnkp.csv`: This has summary information on the detected knickpoints. 
.. `_ksnkp_mchi.csv`: This is a large file with information about all the segments, as well information about stem:[k_{sn}] values, chi-elevation plots, and loads more information. It is the workhorse file for the plotting routines. 
.. `_ksnkp_raw.csv`: Similar to the `_ksnkp.csv` file but contains all unfiltered knickpoint locations so that users can develop their own extraction algorithms. 
.. `_ksnkp_SK.csv`: One day Boris will tell us all what this means. 
